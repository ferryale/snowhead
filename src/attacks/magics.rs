use crate::types::bitboard::*;
use crate::types::square::*;
use crate::types::piece::*;

#[rustfmt::skip]
pub const BISHOP_MAGIC_NUMBERS: [u64; SQUARE_NB] = [9052302183530624u64, 3493106745918750722u64, 10378547575765598208u64, 1737267960881348624u64, 10173093901303832u64, 4666011823880819232u64, 595602155869570050u64, 4611897984056627264u64, 36249008850862404u64, 2216337449216u64, 2305851882628841472u64, 184651999957483520u64, 7494011856613818624u64, 1197984168606171392u64, 2256765064877074u64, 147774504575173632u64, 9232379519711904000u64, 1589780154182344962u64, 5843420671266299912u64, 2306970043015012930u64, 291610284032786432u64, 1412881035952660u64, 18577349571281920u64, 288265571328395280u64, 20398418977359873u64, 4616194017980600448u64, 2308105804345245712u64, 4611826893489045536u64, 9009398294841476u64, 2634606881531924610u64, 283674285703424u64, 1261300437177876736u64, 19333830213640194u64, 9225705209122014272u64, 36314674337548288u64, 5188148971919900801u64, 16289522094180425736u64, 81082939529527360u64, 5198622926656012808u64, 9656916352225543296u64, 2261180160746545u64, 40818338457190912u64, 1152932510729241088u64, 148919646538486784u64, 10134203572167168u64, 1135797138883072u64, 164383759939144704u64, 9233225930963681536u64, 100207325126067208u64, 1153207386539033088u64, 4611361466745472u64, 57139560060289058u64, 288248037091186432u64, 1301584865623408704u64, 75611525158570019u64, 146384586526490896u64, 1164255287713071617u64, 288338171259344900u64, 5764607534879117377u64, 1157495747864957184u64, 3222077704u64, 4616752605052544032u64, 2343072610411356416u64, 73218686973968530u64, ];
pub const BISHOP_MAGICS: [Magic; SQUARE_NB] = init_magics(BISHOP_MAGIC_NUMBERS, BISHOP, 0);

#[rustfmt::skip]
pub const ROOK_MAGIC_NUMBERS: [u64; SQUARE_NB] = [2630106718943609138u64, 18032010559799296u64, 180161586023891074u64, 2449967268337156128u64, 36037593179127810u64, 1297037861652529664u64, 216173881668150784u64, 144115755014179329u64, 9516246750663278729u64, 2392674749399056u64, 14777779876790404u64, 578853461412548608u64, 36169551687712896u64, 4925820690762752u64, 422225358362112u64, 10387834016590004226u64, 468374636126535876u64, 2305918051150733312u64, 1153062792119508996u64, 40532946536465424u64, 5770519597325746180u64, 9223662312756613184u64, 36103566096597521u64, 9228176902740050052u64, 1242995973202911360u64, 301811597467189376u64, 3103015342663795328u64, 5944769102463107204u64, 5764629515414798465u64, 3458766714999669760u64, 288232592363292688u64, 290483284066992324u64, 351855003566724u64, 1371381339630076098u64, 2307021687834566656u64, 576496040862028288u64, 2955521640369152u64, 24910690066104832u64, 149602367980033u64, 140738620818688u64, 140738562129952u64, 4620836158493032480u64, 1157636347922546704u64, 4802950260195336u64, 8800388317200u64, 297959129979814176u64, 9017713502715912u64, 360429292935315457u64, 2306267730627658240u64, 666534181534443776u64, 360596933493932288u64, 288250168435319296u64, 7036908795364608u64, 2307531895849878016u64, 864708755556017152u64, 11608168789920731776u64, 144255964230459459u64, 4719808153548554754u64, 36117037123772417u64, 4756118072021484801u64, 581245895669196801u64, 563037070164226u64, 4684025104663969825u64, 2256199512819778u64, ];
pub const ROOK_MAGICS: [Magic; SQUARE_NB] = init_magics(ROOK_MAGIC_NUMBERS, ROOK, 5248);

#[derive(Clone, Copy, Debug)]
pub struct Magic {
    pub mask: Bitboard,
    pub magic: u64,
    pub offset: usize,
    pub shift: u32,
}

impl Magic {
    pub const fn default() -> Magic {
        Magic {
            mask: EMPTY_BB,
            magic: 0,
            offset: 0,
            shift: 0,
        }
    }

    pub fn index(&self, occ: Bitboard) -> usize {
        #[cfg(all(target_arch = "x86_64", target_feature = "bmi2"))]
        {
            use std::arch::x86_64::_pext_u64;
            self.offset + unsafe { _pext_u64(occ.0, self.mask.0) } as usize
        }
        #[cfg(not(all(target_arch = "x86_64", target_feature = "bmi2")))]
        {
        self.offset + ((occ & self.mask).0.wrapping_mul(self.magic) >> self.shift) as usize
        }
    }
}

pub const fn init_magics(
    magic_nums: [u64; 64],
    pt: PieceType,
    mut offset: usize,
) -> [Magic; 64] {
    let mut magics = [Magic::default(); SQUARE_NB];
    let mut s_idx = 0;
    while s_idx < SQUARE_NB {
        magics[s_idx].magic = magic_nums[s_idx];
        magics[s_idx].mask = occupancy_mask(Square(s_idx as u32), pt);
        magics[s_idx].shift = 64 - popcount(magics[s_idx].mask);
        magics[s_idx].offset = offset;
        offset += 1 << (64 - magics[s_idx].shift);
        s_idx += 1;
    }
    magics
}

const fn occupancy_mask(s: Square, pt: PieceType) -> Bitboard {
    
    // Board edges are not considered in the relevant occupancies
    let edges = ((RANK_1_BB.0 | RANK_8_BB.0) & !super::rank_bb(s.rank()).0) 
                | ((FILE_A_BB.0 | FILE_H_BB.0) & !super::file_bb(s.file()).0);

    let mask = super::sliding_attacks(pt, s, EMPTY_BB).0 & !edges;

    Bitboard(mask)
}